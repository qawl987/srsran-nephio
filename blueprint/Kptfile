apiVersion: kpt.dev/v1
kind: Kptfile
metadata:
  name: pkg-srsran
  annotations:
    config.kubernetes.io/local-config: "true"
info:
  description: |
    srsRAN blueprint package for Nephio – disaggregated O-RAN architecture.

    This package deploys three separate pods per SrsRanDeployment:
      CU-CP  – binds N2 (NGAP→AMF), E1 (E1AP server), F1C (F1-AP server)
      CU-UP  – binds N3 (GTP-U→UPF), E1 (E1AP client), F1U (GTP-U→DU)
      DU     – binds F1C/F1U (←CU), ZMQ RF (→UE or RadioBreaker)

    All inter-pod addresses are real routed IPs injected by Nephio IPAM.
    Loopback addresses (127.x.x.x) are never used.

    Lifecycle summary:
      1. A user creates a PackageRevision referencing this blueprint.
      2. Nephio's apply-replacements propagates the package name and
         namespace into the Interface / Capacity resource annotations.
      3. interface-fn allocates five IPs (N2, N3, E1, F1C, F1U) from the
         cluster's IPAM pools and writes them into
         spec.interfaces.{n2,n3,e1,f1c,f1u}.ipAddress.
      4. nfdeploy-fn converts the SrsRanDeployment spec into the canonical
         NFDeployment shape expected by the srsran-operator.
      5. The srsran-operator reads the injected IPs and deploys CU-CP, CU-UP,
         DU, UE(s), and optional RadioBreaker pods.
  keywords:
    - srsran
    - ran
    - nephio
    - 5g
    - oran

pipeline:
  mutators:
    # ── Step 1: propagate the package owner name into resource annotations ──
    - image: ghcr.io/kptdev/krm-functions-catalog/apply-replacements:v0.1.1
      configPath: apply-replacements-owner.yaml

    # ── Step 2: propagate the package namespace into resource annotations ──
    - image: ghcr.io/kptdev/krm-functions-catalog/apply-replacements:v0.1.1
      configPath: apply-replacements-namespace.yaml

    # ── Step 3: set the namespace on all resources ──
    - image: ghcr.io/kptdev/krm-functions-catalog/set-namespace:v0.4.1
      configPath: package-context.yaml

    # ── Step 4: allocate IPs for every Interface resource in the package ──
    #   Interface resources: n2, n3, e1, f1c, f1u
    #   Each gets its CIDR written back into the SrsRanDeployment CR via the
    #   specializer.nephio.org/owner annotation on each Interface resource.
    - image: docker.io/nephio/interface-fn:latest

    # ── Step 5: create NetworkAttachmentDefinitions for multus ──
    - image: docker.io/nephio/nad-fn:latest

    # ── Step 6: inject capacity annotations based on Capacity resource ──
    - image: docker.io/nephio/nfdeploy-fn:latest
